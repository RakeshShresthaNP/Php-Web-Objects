<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PWO Real-Time Chat</title>
<style>
body {
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	background: #e5ddd5;
	margin: 0;
	display: flex;
	flex-direction: column;
	height: 100vh;
}

/* Header & Status */
header {
	background: #075e54;
	color: white;
	padding: 15px;
	display: flex;
	justify-content: space-between;
	align-items: center;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

#status-dot {
	height: 10px;
	width: 10px;
	background-color: #bbb;
	border-radius: 50%;
	display: inline-block;
	margin-right: 5px;
}

.online {
	background-color: #25d366 !important;
}

/* Chat Window */
#chat-window {
	flex: 1;
	overflow-y: auto;
	padding: 20px;
	display: flex;
	flex-direction: column;
	gap: 10px;
}

.msg-wrap {
	max-width: 70%;
	padding: 8px 12px;
	border-radius: 8px;
	position: relative;
	font-size: 14px;
	box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
}

.msg-remote {
	align-self: flex-start;
	background: white;
}

.msg-me {
	align-self: flex-end;
	background: #dcf8c6;
}

.sender {
	font-weight: bold;
	font-size: 11px;
	color: #075e54;
	display: block;
	margin-bottom: 3px;
}

.time {
	font-size: 10px;
	color: #999;
	text-align: right;
	margin-top: 4px;
}

/* Input Area */
footer {
	background: #f0f0f0;
	padding: 10px;
	display: flex;
	gap: 10px;
	border-top: 1px solid #ddd;
}

#msg-input {
	flex: 1;
	padding: 12px;
	border: none;
	border-radius: 20px;
	outline: none;
}

button {
	background: #075e54;
	color: white;
	border: none;
	padding: 0 20px;
	border-radius: 20px;
	cursor: pointer;
	font-weight: bold;
}

button:hover {
	background: #128c7e;
}
</style>
</head>
<body>

	<header>
		<div>PWO Global Chat</div>
		<div style="font-size: 12px;">
			<span id="status-dot"></span> <span id="status-text">Connecting...</span>
		</div>
	</header>

	<div id="chat-window"></div>

	<footer>
		<input type="text" id="msg-input" placeholder="Type a message..."
			autocomplete="off">
		<button id="send-btn">SEND</button>
	</footer>

	<script src="assets/dashboard/wsclient.js"></script>

	<script>	
	const pwoToken = "<?php echo $_SESSION['pwo_token'] ?? ''; ?>";
    	
    // 1. Initialize WSClient
    const ws = new WSClient('ws://127.0.0.1:8080', 'pwo_token');
    ws.connect();

    // Get current user permissions from your framework's global state if available
    // or decode it from your 'pwo_token'. 
    const userPerms = "<?php echo $_SESSION['user_perms'] ?? 'user'; ?>"; 

    const chatWin = document.getElementById('chat-window');
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');

    // --- UI EVENT LISTENERS ---

    window.addEventListener('ws_connected', () => {
        document.getElementById('status-dot').classList.add('online');
        document.getElementById('status-text').innerText = 'Online';
        ws.call('chat', 'history');
    });

    window.addEventListener('ws_disconnected', () => {
        document.getElementById('status-dot').classList.remove('online');
        document.getElementById('status-text').innerText = 'Offline (Reconnecting...)';
    });

    window.addEventListener('ws_new_message', (e) => {
        renderMessage(e.detail, 'remote');
    });

    window.addEventListener('ws_chat_confirmation', (e) => {
        renderMessage(e.detail, 'me');
    });

    window.addEventListener('ws_chat_history', (e) => {
        chatWin.innerHTML = ''; 
        e.detail.history.forEach(item => {
            // Mapping your history columns: id, realname (sender), message, time
            renderMessage({ 
                id: item.id, 
                sender: item.sender, 
                message: item.message, 
                time: item.time 
            }, 'remote');
        });
    });

    // Handle the deletion broadcast from the server
    window.addEventListener('ws_message_deleted', (e) => {
        const messageId = e.detail.id;
        const element = document.getElementById(`msg-${messageId}`);
        if (element) {
            element.style.transition = "all 0.4s ease";
            element.style.opacity = "0";
            element.style.transform = "translateX(20px)";
            setTimeout(() => element.remove(), 400);
        }
    });

    // --- LOGIC ---

    function sendMessage() {
        const text = msgInput.value.trim();
        if (text !== "") {
            ws.call('chat', 'send', { message: text });
            msgInput.value = '';
        }
    }

    function renderMessage(data, type) {
        const div = document.createElement('div');
        
        // Use the ID from chat_logs table to identify the element
        if (data.id) div.id = `msg-${data.id}`;
        
        div.className = `msg-wrap ${type === 'me' ? 'msg-me' : 'msg-remote'}`;
        
        // Show delete button only for admin/superadmin perms found in your database
        let deleteHtml = '';
        if (userPerms === 'admin' || userPerms === 'superadmin') {
            deleteHtml = `<span onclick="deleteMessage(${data.id})" style="float:right; cursor:pointer; color:#cc0000; font-weight:bold; margin-left:10px;">&times;</span>`;
        }
        
        div.innerHTML = `
            ${deleteHtml}
            <span class="sender">${data.sender}</span>
            <span class="text">${data.message}</span>
            <div class="time">${data.time || ''}</div>
        `;
        
        chatWin.appendChild(div);
        chatWin.scrollTop = chatWin.scrollHeight;
    }

    /**
     * Admin-only function to trigger deletion
     */
    function deleteMessage(id) {
        if (!id) return;
        if (confirm("Are you sure you want to delete this message?")) {
            ws.call('chat', 'delete', { message_id: id });
        }
    }

    sendBtn.onclick = sendMessage;
    msgInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
</script>

</body>
</html>